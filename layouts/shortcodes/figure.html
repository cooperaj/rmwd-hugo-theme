{{- $respSizes := slice "500" "850" "1200" -}}
{{- $src := .Get "src" -}}
{{- $resource := $src -}}

{{- $hint := default "photo" (.Get "hint") -}}
{{- $filter := default false (.Get "filter") -}}
{{- $inGallery := false }}
{{- $imgClass := default "" (.Get "class") }}

{{- if (findRE "(^|:)//" $src) -}}
    {{- with resources.GetRemote $src -}}
        {{- with .Err }}
            {{- errorf "%s" . -}}
        {{- else -}}
            {{- $resource = . -}}
            {{- $src = $resource.RelPermalink -}}
        {{- end -}}
    {{- else -}}
        {{- errorf "Unable to get remote resource %q" $src -}}
    {{- end -}}
{{- else -}}
    {{- $resource = .Page.Resources.GetMatch (printf "*%s*" $src) -}}
    {{- $src = $resource.RelPermalink -}}
    {{- if .Parent -}} <!-- am nested shortcode -->
        {{- if eq .Parent.Name "gallery" -}} <!-- am inside a gallery -->
            {{- $respSizes := slice "150" "275" "380" -}}
            {{- $inGallery = true -}}
            {{- $imgClass = "is-square" -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- if $inGallery -}}<div class="column is-half-mobile is-one-quarter-tablet is-2-desktop">{{- end -}}
<figure class="{{ $imgClass }}" itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <a href="{{ with .Get "link" }}{{.}}{{ else }}{{ $src }}{{ end }}" {{ with .Get "size" }}data-size="{{.}}"{{ end }} itemprop="contentUrl"> 
        <picture>
            <source type="image/webp" srcset="
            {{- with $respSizes -}}
                {{- range $i, $e := . -}}
                    {{- if ge $resource.Width . -}}
                        {{- $dim := printf "resize %sx Lanczos" . -}}
                        {{- if $inGallery -}}{{- $dim = printf "fill %sx%s smart" . . -}}{{- end -}}
                        {{- if $i }}, {{ end -}}{{- ($resource.Process (print $dim " webp " $hint " " $filter) ).RelPermalink }} {{ . }}w
                    {{- end -}}
                {{- end -}}
            {{- end -}}" sizes="(min-width: 769px) 70vw, 100vw" />

            <source srcset="
            {{- with $respSizes -}}
                {{- range $i, $e := . -}}
                    {{- if ge $resource.Width . -}}
                        {{- $dim := printf "resize %sx Lanczos" . -}}
                        {{- if $inGallery -}}{{- $dim = printf "fill %sx%s smart" . . -}}{{- end -}}
                        {{- if $i }}, {{ end -}}{{- ($resource.Process (print $dim " " $filter) ).RelPermalink }} {{ . }}w
                    {{- end -}}
                {{- end -}}
            {{- end -}}" sizes="(min-width: 769px) 70vw, 100vw" />

            <img itemprop="thumbnail" src="{{ $src }}" loading="lazy"
            {{- if (or (.Get "alt") (.Get "caption")) -}}
                {{- with .Get "alt"}}
                    {{- printf " alt=\"%s\"" . | safeHTMLAttr -}}
                {{- else -}}
                    {{- printf " alt=\"%s\"" (.Get "caption" | markdownify | plainify) | safeHTMLAttr -}}
                {{- end -}}
            {{- end -}}
            {{- if .Get "title" -}}
                {{- printf " title=\"%s\"" (.Get "title") | safeHTMLAttr -}}
            {{- end -}}
            {{- with .Get "width" }} width="{{ . }}"{{ end -}}
            {{- with .Get "height" }} height="{{ . }}"{{ end -}} /> <!-- Closing img tag -->
        </picture>
    </a>
    {{- if (or (.Get "caption") (.Get "attr")) -}}
        <figcaption>
            {{ if (or (.Get "caption") (.Get "attr")) }}<p>
                {{ .Get "caption" | markdownify }}
                {{ with .Get "attrlink" }}<a href="{{ . }}"> {{ end }}
                    {{ .Get "attr" | markdownify }}
                    {{ if .Get "attrlink" }}</a>{{ end }}</p>
            {{ end }}
        </figcaption>
    {{- end -}}
</figure>
{{- if $inGallery -}}</div>{{- end -}} <!-- Closing gallery div -->